<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css"
    integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      color: white;
      background: black;
    }
  </style>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <title>Sign-in</title>
</head>

<body>
  <h1 id="welcome-message">Welcome User</h1>
  <h2>My Recipes</h2>
  <div id="app">
    <ul>
      <li v-for="recipe in recipes">
        {{recipe.name}}
        <button @click="deleteRecipe(recipe)">Delete</button>
        <button @click="toggleEditRecipeForm(recipe)">Update</button>
        <form v-if="isRecipeEditVisible.includes(recipe.id)" @submit.prevent="updateRecipe(recipe)">
          <label>
            <span>Recipe Name</span>
            <input type="text" v-model="recipeEdits.find(recipeEdit => recipeEdit.recipeId === recipe.id).editedName"
              name="recipeName">
            <button type="submit">Submit</button>
          </label>
        </form>
      </li>
    </ul>
    <button @click="toggleAddRecipeForm">{{ toggleButtonLabel }}</button>
    <form v-if="isFormVisible" @submit.prevent="addRecipe">
      <label>
        <span>Recipe Name</span>
        <input type="text" name="recipeName" v-model="addRecipeName" label="Recipe Name">
        <button type="submit">Submit</button>
      </label>
    </form>
    <button @click="signOut"> Sign Out</button>
  </div>
  <script>
    let app = Vue.createApp({
      async mounted() {
        this.recipes = await this.fetchRecipes()
      },
      data() {
        return {
          isFormVisible: false,
          recipes: [],
          addRecipeName: "",
          recipeEdits: [{
            recipeId: -1,
            //isEditVisible: false,
            editedName: ""
          }],
          isRecipeEditVisible: []

        }

      },
      computed: {
        toggleButtonLabel() {
          if (this.isFormVisible) {
            return "Cancel"
          }
          else {
            return "Add Recipe"
          }
        }
      },
      methods: {
        async fetchRecipes() {
          if (!localStorage.getItem("authToken")) {
            this.goToSignIn()
          }
          else {
            let url = '/api/recipes'
            let options = {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem("authToken")}`
              }
            }
            console.log(options)
            const response = await fetch(url, options)
            const json = await response.json()
            return json.recipes
          }
        },
        async deleteRecipe(recipe) {
          let url = `/api/recipes/${recipe.id}`
          let token = localStorage.getItem("authToken")
          let options = {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          }
          console.log(options)
          const response = await fetch(url, options)
          const json = await response.json()
          this.recipes = json.recipes

        },
        async updateRecipe(recipe) {
          let url = `/api/recipes/${recipe.id}`
          let token = localStorage.getItem("authToken")
          console.log()
          recipe.name = this.recipeEdits.find(recipeEdit => recipeEdit.recipeId === recipe.id).editedName
          let body = { recipe }
          let options = {
            method: 'PUT',
            body: JSON.stringify(body),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          }
          try {
            const response = await fetch(url, options)
            const json = await response.json()
            this.recipes = json.recipes
            console.log('got here')
            this.toggleEditRecipeForm(recipe) // Why doesn't this clear my form? 

          } catch (error) {
            console.error('Error updating the recipe:', error)
          }

        },
        async addRecipe(event) {
          let url = '/api/recipes'
          let token = localStorage.getItem("authToken")
          let recipe = {
            name: event.target.elements.recipeName.value
          }
          let body = { recipe }
          let options = {
            method: 'POST',
            body: JSON.stringify(body),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          }
          const response = await fetch(url, options)
          const json = await response.json()
          this.recipes = json.recipes
          this.addRecipeName = ""
        },
        toggleAddRecipeForm() {
          if (this.isFormVisible) {
            this.isFormVisible = false
          }
          else {
            this.isFormVisible = true
          }
        },
        toggleEditRecipeForm(recipe) {
          if (this.isRecipeEditVisible.includes(recipe.id)) {
            console.log('hiding the form')
            this.isRecipeEditVisible = this.isRecipeEditVisible.filter(id => id !== recipe.id)
            this.recipeEdits = this.recipeEdits.filter(recipeEdit => recipeEdit.recipeId !== recipe.id);
          }
          else {
            console.log('showing the form')
            this.isRecipeEditVisible.push(recipe.id)
            let recipeEdit = {
              recipeId: recipe.id,
              editedName: recipe.name
            }
            this.recipeEdits.push(recipeEdit)
            console.log(this.recipeEdits)
          }
        },
        signOut() {
          localStorage.removeItem("authToken")
          this.goToSignIn()
        },

        goToSignIn() {
          window.location.href = '/'
        }
      }
    })
    app.mount('#app')
  </script>
</body>

</html>